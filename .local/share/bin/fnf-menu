#!/bin/bash

set -euo pipefail

FILENAME="$(basename "$0")"
VERSION="latest"
TERMINAL=${TERMINAL:-"kitty"}
CONFIG_HOME=${XDG_CONFIG_HOME:-~/.config}
DATA_HOME=${XDG_DATA_HOME:-~/.local/share}
FNF_CONFIG_DIR=${CONFIG_HOME}/fnf
FNF_DATA_DIR=${DATA_HOME}/fnf

export PATH="${FNF_DATA_DIR}/bin:$PATH"

version() {
  printf '%s\n' "$VERSION"
}

terminal() {
  ${TERMINAL} -e "$@"
}

help() {
  cat <<EOF
Usage: ${FILENAME} <command> [flags]

A tool for desktop menu.

Flags:
  -h, --help       Show this help information.
  -v, --version    Print the version number.

Commands:
  show        Show menus.
  reload      Reload configurations.
  run         Run utility commands.

Run "${FILENAME} <command> --help" for more information on a command.

EOF
}

show_help() {
  cat <<EOF
Usage: ${FILENAME} show <command> [flags]

Show desktop-related menu.

Flags:
  -h, --help    Show this help information.

Commands:
  main       Show the main menu.

EOF
}

show_main_cmd() {
  local selected=""
  selected=$(
    ROFI_WINDOW_WIDTH=250 rofi -dmenu -i -p "Menu:" <<EOL
About
Application
Emoji
Theme
Wallpaper
Install/Uninstall
Setting
System
EOL
  )

  case "$selected" in
  *About*) gtk-launch About.desktop ;;
  *Application*) drun_cmd ;;
  *Emoji*) emojipicker_cmd ;;
  *Theme*) themepicker_cmd ;;
  *Wallpaper*) wallpicker_cmd ;;
  *Install/Uninstall*) show_install_cmd ;;
  *Setting*) show_setting_cmd ;;
  *System*) show_system_cmd ;;
  *) log_error "Unknown selection: $selected" ;;
  esac
}

show_setting_cmd() {
  local selected=""
  selected=$(echo -e "Bluetooth\nBluetooth (TUI)\nBluetooth (TUIth)\nNetwork\nNetwork (TUI)\nVolume\nVolume (TUI)" |
    ROFI_WINDOW_WIDTH=250 rofi -dmenu -i -p "Setting:") || selected=""

  case "$selected" in
  *Bluetooth) blueman_cmd ;;
  *Bluetooth*TUI\)) bluetui_cmd ;;
  *Bluetooth*TUIth\)) bluetuith_cmd ;;
  *Network) nm_connection_editor_cmd ;;
  *Network*TUI*) wifitui_cmd ;;
  *Volume) volume_control_cmd ;;
  *Volume*TUI*) wiremix_cmd ;;
  "") show_main_cmd ;;
  *) log_error "Unknown selection: $selected" ;;
  esac
}

show_system_cmd() {
  local selected=""
  selected=$(echo -e "Poweroff\nReboot\nLock\nExit" |
    ROFI_WINDOW_WIDTH=250 rofi -dmenu -i -p "System:") || selected=""

  case "$selected" in
  *Poweroff*) systemctl poweroff ;;
  *Reboot*) systemctl reboot ;;
  *Lock*) hyprlock ;;
  *Exit*) uwsm stop ;;
  "") show_main_cmd ;;
  *) log_error "Unknown selection: $selected" ;;
  esac
}

show_install_cmd() {
  local selected=""
  selected=$(echo -e "Web App" |
    ROFI_WINDOW_WIDTH=300 rofi -dmenu -i -p "Install/Uninstall:") || selected=""

  case "$selected" in
  *Web\ App*) show_install_webapp_cmd ;;
  "") show_main_cmd ;;
  *) log_error "Unknown selection: $selected" ;;
  esac
}

show_install_webapp_cmd() {
  local selected=""
  selected=$(echo -e "Install" |
    ROFI_WINDOW_WIDTH=250 rofi -dmenu -i -p "Web app:") || selected=""

  case "${selected}" in
  *Install*) install_webapp_cmd ;;
  "") show_install_cmd ;;
  *) log_error "Unknown selection: $selected" ;;
  esac
}

install_webapp_cmd() {
  local app_name=""
  local app_url=""
  local app_icon=""
  app_name=$(zenity --entry --text="App name:" --entry-text="My App" --title="Install Web App")
  app_url=$(zenity --entry --text="App URL:" --entry-text="https://example.com" --title="Install Web App")
  app_icon=$(zenity --entry --text="App icon URL:" --entry-text="Must use PNG!" --title="Install Web App" --width 400 --extra-button="Choose file..." || true)

  if [[ -z "${app_name}" || -z "${app_url}" || -z "${app_icon}" ]]; then
    log_error "App name, URL, or icon cannot be empty"
    return 1
  fi

  local install_desktop_file="${DATA_HOME}/applications/${app_name}.desktop"
  local install_icon_dir="${DATA_HOME}/applications/icons"
  local icon_path=""

  if [[ "${app_icon}" == "Choose file..." ]]; then
    icon_path=$(zenity --file-selection --file-selection --file-filter="PNG files | *.png" --title="Install Web App")
  else
    local icon_ext="${app_icon##*.}"
    icon_path="${install_icon_dir}/${app_name}.${icon_ext}"

    if ! curl -sLo "${icon_path}" "${app_icon}"; then
      log_error "Failed to download icon from ${app_icon}"
      return 1
    fi
  fi

  mkdir -p "${install_icon_dir}"

  cat >"${install_desktop_file}" <<EOF
[Desktop Entry]
Version=1.0
Type=Application
Name=${app_name}
Comment=${app_name}
Exec=brave --new-window --app="${app_url}"
Terminal=false
Icon=${icon_path}
StartupNotify=true
EOF

  notify-send --icon="${icon_path}" "${app_name} (web app)" "${app_name} has successfully installed."
}

show_cmd() {
  if [[ "$#" -lt 1 || "$1" = "-h" || "$1" = "--help" ]]; then
    show_help
    return 0
  fi

  cmd="$1"
  case "$cmd" in
  main) show_main_cmd ;;
  -h | --help) show_help ;;
  *) log_error "Unknown command: $cmd" && show_help && exit 2 ;;
  esac
}

reload_help() {
  cat <<EOF
Usage: ${FILENAME} reload <command> [flags]

Reload a configuration.

Flags:
  -h, --help    Show this help information.

Commands:
  ghostty   Reload all of Ghostty configuration in every windows.
  hyprland  Reload Hyprland configuration.
  kitty     Reload Kitty configuration.
  waybar    Reload waybar configuration and style.
  tmux      Reload tmux configuration.

EOF
}

reload_cmd() {
  if [[ "$#" -lt 1 || "$1" = "-h" || "$1" = "--help" ]]; then
    reload_help
    return 0
  fi

  cmd="$1"
  case "$cmd" in
  ghostty) reload_ghostty_cmd ;;
  kitty) reload_kitty_cmd ;;
  hyprland) reload_hyprland_cmd ;;
  waybar) reload_waybar_cmd ;;
  tmux) reload_tmux_cmd ;;
  -h | --help) reload_help ;;
  *) log_error "Unknown command: $cmd" && reload_help && exit 2 ;;
  esac
}

run_help() {
  cat <<EOF
Usage: ${FILENAME} run <command> [flags]

Run desktop utility command.

Flags:
  -h, --help    Show this help information.

Commands:
  about                  Show system informations.
  blueman-manager        Launch Bluetooth Manager.
  bluetui                Launch bluetui.
  bluetuith              Launch bluetuith.
  emoji                  Launch emoji picker.
  nm-connection-editor   Launch Advanced Network Configuration.
  nmtui                  Launch nmtui.
  theme                  Launch theme picker.
  wallpaper              Launch wallpaper picker.
  wifitui                Launch wifitui.

EOF
}

run_cmd() {
  if [[ "$#" -lt 1 || "$1" = "-h" || "$1" = "--help" ]]; then
    run_help
    return 0
  fi

  cmd="$1"
  case "$cmd" in
  about) about_cmd ;;
  blueman-manager) blueman_cmd ;;
  bluetui) bluetui_cmd ;;
  bluetuith) bluetuith_cmd ;;
  drun) drun_cmd ;;
  emoji) emojipicker_cmd ;;
  nm-connection-editor) nm_connection_editor_cmd ;;
  nmtui) nmtui_cmd ;;
  wallpaper) wallpicker_cmd ;;
  wiremix) wiremix_cmd ;;
  theme) themepicker_cmd ;;
  -h | --help) run_help ;;
  *) log_error "Unknown command: $cmd" && run_help && exit 2 ;;
  esac
}

about_cmd() {
  # terminal 'fastfetch; read -n 1 -s'
  gtk-launch About.desktop
}

blueman_cmd() {
  gtk-launch blueman-manager.desktop
}

bluetui_cmd() {
  ${TERMINAL} --class com.fnf.bluetui bluetui
}

bluetuith_cmd() {
  ${TERMINAL} --class com.fnf.bluetuith bluetuith
}

wallpicker_cmd() {
  local current=""
  local selected_idx=0
  local list=()

  mapfile -d '' list < <(find \
    ~/Pictures \
    "${FNF_CONFIG_DIR}/current/theme/wallpapers" \
    -type f \
    -print0 \
    -name "*.png" -o -name "*.jpg" -o -name "*jpeg" |
    sort --zero-terminated --reverse)

  if [[ -L "${FNF_CONFIG_DIR}/current/wallpaper" ]]; then
    current=$(readlink "${FNF_CONFIG_DIR}/current/wallpaper")

    local i=0
    for data in "${list[@]}"; do
      if [[ "${current}" == "${data}" ]]; then
        selected_idx="${i}"
        break
      fi
      ((i += 1))
    done
  fi

  local dmenu=""
  dmenu=$(
    IFS=$'\n'
    echo "${list[*]}"
  )

  local args=()
  args=("-dmenu" "-i" "-p" "Wallpaper:" "-selected-row" "${selected_idx}")

  if [[ "${current}" != "" ]]; then
    args=("${args[@]}" "-a" "${selected_idx}" -mesg "Current wallpaper: ${current}")
  fi

  local selected=""
  selected=$(
    # Icon setup for rofi to render
    while IFS= read -r entry; do
      echo -en "${entry}\x00icon\x1f${entry}\n"
    done <<<"${dmenu}" |
      ROFI_WINDOW_WIDTH=900 \
        ROFI_PREVIEW=true \
        rofi "${args[@]}"
  )

  if [[ "${selected}" != "" ]] && [[ "${current}" != "${selected}" ]]; then
    log_info "Changing wallpaper from ${current} to ${selected}"

    ln -snf "${selected}" "${FNF_CONFIG_DIR}/current/wallpaper"
    hyprctl hyprpaper wallpaper , "${selected}" >/dev/null
  fi
}

themepicker_cmd() {
  local current=""

  [ -h "${FNF_CONFIG_DIR}/current/theme" ] && current=$(readlink "${FNF_CONFIG_DIR}/current/theme")

  local list=()

  mapfile -d '' list < <(find \
    "${FNF_DATA_DIR}/themes" \
    -maxdepth 1 \
    -mindepth 1 \
    -print0 |
    sort)

  local selected_idx=0

  if [[ "${current}" != "" ]]; then
    local i=0
    for data in "${list[@]}"; do
      if [[ "${current}" == "${data}" ]]; then
        selected_idx="${i}"
        break
      fi
      ((i += 1))
    done
  fi

  local dmenu=""
  dmenu=$(
    IFS=$'\n'
    echo "${list[*]}"
  )

  local args=()
  args=("-dmenu" "-i" "-p" "Theme:" "-selected-row" "${selected_idx}")

  if [[ "${current}" != "" ]]; then
    args=("${args[@]}" "-a" "${selected_idx}" "-mesg" "Current theme: ${current}")
  fi

  local selected=""
  selected=$(echo -en "${dmenu}" | rofi "${args[@]}")

  if [[ "${current}" != "${selected}" ]]; then
    log_info "Changing theme from ${current} to ${selected}"

    ln -snf "${selected}" "${FNF_CONFIG_DIR}/current/theme"

    ln -snf "${selected}/btop.theme" "${CONFIG_HOME}/btop/themes/current.theme"

    reload_ghostty_cmd
    reload_kitty_cmd
    reload_waybar_cmd
    reload_hyprland_cmd
    reload_swaync_cmd
    reload_tmux_cmd
  fi
}

drun_cmd() {
  rofi -show drun -i
}

emojipicker_cmd() {
  ROFI_ELEMENT_ICON_SIZE=0 \
    rofi -show emoji -i
}

nm_connection_editor_cmd() {
  gtk-launch nm-connection-editor.desktop
}

nmtui_cmd() {
  ${TERMINAL} --class com.fnf.nmtui nmtui
}

wifitui_cmd() {
  ${TERMINAL} --class com.fnf.wifitui wifitui
}

volume_control_cmd() {
  gtk-launch org.pulseaudio.pavucontrol.desktop
}

wiremix_cmd() {
  ${TERMINAL} --class com.fnf.wiremix wiremix
}

reload_ghostty_cmd() {
  local keybind=""
  local addresses=()
  keybind="CTRL SHIFT, comma"
  mapfile -t addresses < <(hyprctl clients -j | jq -r '.[] | select(.class == "com.mitchellh.ghostty") | .address')

  for address in "${addresses[@]}"; do
    hyprctl dispatch sendshortcut "${keybind}, address:${address}" >/dev/null
  done
}

reload_kitty_cmd() {
  pkill --exact -SIGUSR1 kitty
}

reload_hyprland_cmd() {
  hyprctl reload
}

reload_waybar_cmd() {
  pkill -SIGUSR2 waybar
}

reload_swaync_cmd() {
  swaync-client --reload-css
}

reload_tmux_cmd() {
  if tmux list-sessions >/dev/null 2>&1; then
    tmux source-file "${CONFIG_HOME}/tmux/tmux.conf"
  fi
}

# -----------------------
# Helpers
# -----------------------
log_info() { printf "$(date '+%Y-%m-%d %H:%M:%S.%3N') INFO: %s\n" "$*"; }
log_error() { printf "$(date '+%Y-%m-%d %H:%M:%S.%3N') ERROR: %s\n" "$*" >&2; }

main() {
  if [ $# -eq 0 ]; then
    help
    return 0
  fi

  # Global flags may appear before command
  case "$1" in
  -h | --help) help ;;
  -v | --version) version ;;
  esac

  cmd="$1"

  case "$cmd" in
  show) show_cmd "${@:2}" ;;
  reload) reload_cmd "${@:2}" ;;
  run) run_cmd "${@:2}" ;;
  -h | --help) help ;;
  -v | --version) version ;;
  *) log_error "Unknown command: $cmd" && help && exit 2 ;;
  esac
}

main "$@"
